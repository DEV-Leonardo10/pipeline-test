name: Pipeline html/css

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clonar o c√≥digo
        uses: actions/checkout@v4

      - name: Verificar estrutura de arquivos
        run: |
          echo "‚úÖ C√≥digo HTML e CSS recebidos com sucesso!"
          ls -la

      - name: Validar HTML
        run: |
          sudo apt-get update
          sudo apt-get install -y tidy
          for file in *.html; do
            echo "Validando $file..."
            tidy -qe "$file"
          done

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Clonar o c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar csslint
        run: npm install -g csslint

      - name: Validar CSS
        run: |
          for file in *.css; do
            echo "Validando $file..."
            csslint "$file"
          done

  sast:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Clonar o c√≥digo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar ESLint 8
        run: npm install -g eslint@8

      - name: Rodar SAST (eslint)
        run: |
          echo "üîç Rodando SAST (Static Analysis)..."
          eslint . || exit 1

  dast:
    needs: sast
    runs-on: ubuntu-latest
    steps:
      - name: Clonar o c√≥digo
        uses: actions/checkout@v4

      - name: Instalar npm http-server
        run: npm install -g http-server

      - name: Iniciar servidor e rodar DAST
        run: |
          echo "üåê Iniciando servidor local para DAST..."
          nohup http-server . -p 8080 &
          sleep 3
          echo "üîç Rodando DAST (curl checks)..."
          # Exemplo simples de DAST: verifica se a p√°gina inicial retorna 200
          STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" http://localhost:8080)
          if [ "$STATUS" -ne 200 ]; then
            echo "DAST falhou: status $STATUS"
            exit 1
          else
            echo "DAST passou com status $STATUS"
          fi

  deploy:
    needs: dast
    runs-on: ubuntu-latest
    steps:
      - name: Deploy (exemplo)
        run: |
          echo "üöÄ Deploy iniciado..."
          # Coloque aqui seu script de deploy real, por exemplo:
          # rsync, scp, gh-pages, etc.
          echo "Deploy conclu√≠do com sucesso!"
